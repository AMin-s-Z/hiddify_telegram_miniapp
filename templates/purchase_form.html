{% extends "base.html" %}
{% block title %}تکمیل خرید | VPN Store{% endblock %}

{% block setup_main_button %}
    const mainButton = Telegram.WebApp.MainButton;
    mainButton.setText('ارسال رسید و تکمیل خرید');
    mainButton.show();
    mainButton.onClick(function() {
        document.getElementById('uploadForm').submit();
    });
{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-2">
    <div class="card mb-4 fade-in">
        <div class="card-body p-4">
            <h3 class="card-title mb-3"><i class="fas fa-file-invoice text-primary me-2"></i>خلاصه سفارش</h3>
            <div class="d-flex justify-content-between align-items-center">
                <span>پلن: <strong>{{ plan.name }}</strong></span>
                <span class="price-amount">{{ plan.price|floatformat:"0" }} تومان</span>
            </div>
        </div>
    </div>

    <div class="card mb-4 fade-in" style="animation-delay: 0.1s;">
        <div class="card-body p-4">
            <h3 class="card-title mb-3"><i class="fas fa-credit-card text-success me-2"></i>مرحله ۱: پرداخت</h3>
            <div class="alert alert-info small">
                لطفاً مبلغ <strong>{{ plan.price|floatformat:"0" }} تومان</strong> را به شماره کارت زیر واریز کنید.
            </div>
            <div class="bank-card p-3">
                <span class="small text-muted">شماره کارت</span>
                <div class="d-flex justify-content-between align-items-center">
                    <strong class="card-number" id="cardNumber">{{ ADMIN_BANK_CARD }}</strong>
                    <button class="btn btn-sm btn-light copy-btn" data-copy="{{ ADMIN_BANK_CARD }}">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card fade-in" style="animation-delay: 0.2s;">
        <div class="card-body p-4">
            <h3 class="card-title mb-3"><i class="fas fa-upload text-info me-2"></i>مرحله ۲: آپلود رسید</h3>
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                <div class="upload-area mb-3" id="uploadArea">
                    <input type="file" id="receiptImage" name="{{ form.receipt_image.html_name }}" accept="image/*" class="d-none">
                    <label for="receiptImage" class="upload-label">
                        <div id="upload-prompt">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
                            <p class="mb-0">برای آپلود کلیک کنید یا فایل را بکشید</p>
                            <small class="text-muted">حداکثر حجم: 2MB</small>
                        </div>
                        <div id="preview-container" class="d-none">
                            <img id="previewImage" src="" alt="Preview"/>
                            <span id="fileName"></span>
                        </div>
                    </label>
                </div>
                {% if form.receipt_image.errors %}
                <div class="alert alert-danger small p-2">{{ form.receipt_image.errors.0 }}</div>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<style>
    .price-amount {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--tg-theme-accent);
    }
    .bank-card {
        background: var(--tg-theme-bg-color);
        border: 1px solid rgba(var(--tg-theme-text-color-rgb), 0.1);
        border-radius: var(--tg-border-radius-md);
    }
    .card-number {
        letter-spacing: 2px;
        font-size: 1.1rem;
    }
    .copy-btn {
        color: var(--tg-theme-hint-color);
    }
    .upload-area {
        border: 2px dashed rgba(var(--tg-theme-text-color-rgb), 0.2);
        border-radius: var(--tg-border-radius-md);
        background: var(--tg-theme-bg-color);
        transition: border-color 0.2s, background-color 0.2s;
    }
    .upload-area.highlight {
        border-color: var(--tg-theme-accent);
        background-color: rgba(var(--tg-theme-button-color-rgb), 0.1);
    }
    .upload-label {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        min-height: 150px;
        cursor: pointer;
        text-align: center;
    }
    #preview-container img {
        max-height: 100px;
        border-radius: var(--tg-border-radius-sm);
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Copy to clipboard
    document.querySelector('.copy-btn').addEventListener('click', function() {
        const textToCopy = this.getAttribute('data-copy');
        navigator.clipboard.writeText(textToCopy.replace(/\s/g, '')).then(() => {
            alert('شماره کارت کپی شد.');
        });
    });

    // File Upload & Drag-n-Drop
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('receiptImage');
    const uploadPrompt = document.getElementById('upload-prompt');
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('previewImage');
    const fileNameEl = document.getElementById('fileName');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.add('highlight'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('highlight'), false);
    });

    uploadArea.addEventListener('drop', e => {
        fileInput.files = e.dataTransfer.files;
        handleFiles(fileInput.files);
    }, false);

    fileInput.addEventListener('change', () => handleFiles(fileInput.files));

    function handleFiles(files) {
        if (files.length === 0) return;
        const file = files[0];

        if (file.size > 2 * 1024 * 1024) {
            alert('حجم فایل نباید بیشتر از 2 مگابایت باشد.');
            fileInput.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            fileNameEl.textContent = file.name;
            uploadPrompt.classList.add('d-none');
            previewContainer.classList.remove('d-none');
        }
        reader.readAsDataURL(file);
    }
});
</script>
{% endblock %}