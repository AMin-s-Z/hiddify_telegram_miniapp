<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% block title %}فروشگاه VPN{% endblock %}</title>

    <!-- Bootstrap RTL & Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Vazirmatn Font -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vazirmatn@33.0.3/Vazirmatn-font-face.css">
    {% load static %}

    <title>{% block title %}فروشگاه VPN{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vazirmatn@33.0.3/Vazirmatn-font-face.css">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css">
    <style id="telegram-theme"></style>
    <style id="dynamic-styles"></style>
</head>
<body class="telegram-app">
    <!-- Background Pattern -->
    <div class="bg-pattern"></div>

    <!-- Progress Bar -->
    <div id="loading-bar" class="loading-bar"></div>

    <!-- Telegram App Container -->
    <div id="app-container">
        <!-- Animated Header -->
        <header class="tg-header">
            <div class="container-fluid">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <button id="back-button" class="tg-back-button me-2">
                            <i class="fas fa-arrow-left"></i>
                            <span class="ripple-bg"></span>
                        </button>
                        <div class="tg-title-area">
                            <h1 class="tg-title mb-0">
                                <span class="tg-title-icon me-1">🚀</span>
                                <span class="title-text">VPN Store</span>
                            </h1>
                            <div class="tg-subtitle text-muted small">
                                امن، سریع و مطمئن
                            </div>
                        </div>
                    </div>
                    <div class="header-actions">
                        {% block header_actions %}{% endblock %}
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <main class="tg-content">
            <div class="container-fluid px-3">
                <div class="content-wrapper">
                    {% block content %}{% endblock %}
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        {% if user.is_authenticated %}
        <nav class="tg-bottom-nav">
            <div class="nav-container">
                <div class="tg-nav-item {% block nav_plans_active %}{% endblock %}">
                    <a href="{% url 'shop:plan_list' %}" class="tg-nav-link">
                        <div class="nav-icon-wrapper">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <span class="nav-text">پلن‌ها</span>
                    </a>
                </div>
                <div class="tg-nav-item {% block nav_history_active %}{% endblock %}">
                    <a href="{% url 'shop:purchase_list' %}" class="tg-nav-link">
                        <div class="nav-icon-wrapper">
                            <i class="fas fa-history"></i>
                        </div>
                        <span class="nav-text">تاریخچه</span>
                    </a>
                </div>
                <div class="tg-nav-item">
                    <a href="{% url 'shop:logout' %}" class="tg-nav-link">
                        <div class="nav-icon-wrapper">
                            <i class="fas fa-sign-out-alt"></i>
                        </div>
                        <span class="nav-text">خروج</span>
                    </a>
                </div>
            </div>
        </nav>
        {% endif %}
    </div>

    <!-- Main Action Button -->
    <div id="main-button" class="tg-main-button">
        <button class="tg-main-button-text">ادامه</button>
        <div class="button-wave"></div>
    </div>

    <!-- Micro-interactions Helper -->
    <div id="micro-interaction"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>

    <script>
        // Initialize Telegram WebApp
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();

                // Apply Telegram theme colors
                applyTelegramTheme(tg);

                // Setup Back Button
                const backButton = document.getElementById('back-button');
                if (backButton) {
                    backButton.addEventListener('click', function() {
                        if (window.history.length > 1) {
                            window.history.back();
                        } else {
                            tg.close();
                        }
                    });
                }

                // Highlight active nav item
                updateActiveNavItem();

                // Setup Main Button if needed
                {% block setup_main_button %}{% endblock %}
            }

            // Animate on scroll
            initScrollAnimations();

            // Setup ripple effects
            initRippleEffects();

            // Setup micro-interactions
            setupMicroInteractions();
        });

        // Apply Telegram theme colors
        function applyTelegramTheme(tg) {
            const styleElement = document.getElementById('telegram-theme');

            if (tg.colorScheme === 'dark') {
                document.body.classList.add('dark-theme');

                styleElement.textContent = `
                    :root {
                        --tg-theme-bg-color: #${tg.themeParams.bg_color || '212529'};
                        --tg-theme-text-color: #${tg.themeParams.text_color || 'ffffff'};
                        --tg-theme-hint-color: #${tg.themeParams.hint_color || 'aaaaaa'};
                        --tg-theme-link-color: #${tg.themeParams.link_color || '#62bcf9'};
                        --tg-theme-button-color: #${tg.themeParams.button_color || '#2481cc'};
                        --tg-theme-button-text-color: #${tg.themeParams.button_text_color || '#ffffff'};
                        --tg-theme-secondary-bg-color: #${tg.themeParams.secondary_bg_color || '#313338'};
                        --tg-theme-accent: var(--tg-theme-button-color);
                    }
                `;
            } else {
                styleElement.textContent = `
                    :root {
                        --tg-theme-bg-color: #${tg.themeParams.bg_color || 'ffffff'};
                        --tg-theme-text-color: #${tg.themeParams.text_color || '#222222'};
                        --tg-theme-hint-color: #${tg.themeParams.hint_color || '#999999'};
                        --tg-theme-link-color: #${tg.themeParams.link_color || '#2481cc'};
                        --tg-theme-button-color: #${tg.themeParams.button_color || '#0088cc'};
                        --tg-theme-button-text-color: #${tg.themeParams.button_text_color || '#ffffff'};
                        --tg-theme-secondary-bg-color: #${tg.themeParams.secondary_bg_color || '#f0f0f0'};
                        --tg-theme-accent: var(--tg-theme-button-color);
                    }
                `;
            }

            // Dynamic style for highlights
            document.getElementById('dynamic-styles').textContent = `
                .highlight-accent {
                    background-color: var(--tg-theme-accent);
                }
                .border-accent {
                    border-color: var(--tg-theme-accent);
                }
                .text-accent {
                    color: var(--tg-theme-accent);
                }
                .box-shadow-accent {
                    box-shadow: 0 4px 12px rgba(36, 129, 204, 0.15);
                }
            `;
        }

        // Update active nav item in bottom navigation
        function updateActiveNavItem() {
            const navItems = document.querySelectorAll('.tg-nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
                const link = item.querySelector('a');
                if (link && link.href === window.location.href) {
                    item.classList.add('active');
                }
            });
        }

        // Initialize scroll animations
        function initScrollAnimations() {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('fade-in-up');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.animate-scroll').forEach(el => {
                observer.observe(el);
            });
        }

        // Initialize ripple effects
        function initRippleEffects() {
            document.querySelectorAll('.ripple-effect').forEach(element => {
                element.addEventListener('click', function(e) {
                    createRipple(e, this);
                });
            });
        }

        // Create ripple effect
        function createRipple(event, element) {
            const ripple = document.createElement('span');
            const rect = element.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;

            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.classList.add('ripple');

            const ripples = element.querySelectorAll('.ripple');
            if (ripples.length > 0) {
                ripples[ripples.length - 1].remove();
            }

            element.appendChild(ripple);

            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // Setup micro-interactions
        function setupMicroInteractions() {
            // Card hover effect
            document.querySelectorAll('.card-hover').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                    this.classList.add('box-shadow-accent');
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.classList.remove('box-shadow-accent');
                });
            });

            // Button pulse animation
            document.querySelectorAll('.pulse-btn').forEach(btn => {
                btn.addEventListener('mouseenter', function() {
                    this.classList.add('pulse');
                });

                btn.addEventListener('mouseleave', function() {
                    this.classList.remove('pulse');
                });
            });
        }
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>