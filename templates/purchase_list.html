{% extends "base.html" %}
{% block title %}تاریخچه خرید{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">تاریخچه خرید‌های شما</h2>
    <a href="{% url 'shop:plan_list' %}" class="btn btn-primary">
        <i class="fas fa-plus-circle me-1"></i> خرید جدید
    </a>
</div>

{% for purchase in purchases %}
<div class="card mb-4 shadow-sm purchase-card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">{{ purchase.plan.name }}</h5>
            <div>
                {% if purchase.status == 'approved' %}
                <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>تأیید شده</span>
                {% elif purchase.status == 'pending' %}
                <span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>در انتظار تأیید</span>
                {% elif purchase.status == 'rejected' %}
                <span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>رد شده</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="purchase-info">
                    <div class="info-item">
                        <i class="fas fa-calendar-alt text-primary"></i>
                        <span>تاریخ خرید: {{ purchase.purchase_date|date:"Y/m/d H:i" }}</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-money-bill-wave text-primary"></i>
                        <span>قیمت: {{ purchase.plan.price|floatformat:"0" }} تومان</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-hourglass-half text-primary"></i>
                        <span>مدت زمان: {{ purchase.plan.duration }} روز</span>
                    </div>
                </div>
            </div>

            {% if purchase.status == 'approved' and purchase.vpn_config %}
            <div class="col-md-6">
                <div class="mt-3 mt-md-0">
                    <h6 class="fw-bold"><i class="fas fa-shield-alt me-2"></i>کانفیگ VPN شما:</h6>
                    <div class="config-actions mb-2">
                        <button class="btn btn-sm btn-outline-primary copy-config" data-config="{{ purchase.vpn_config }}">
                            <i class="fas fa-copy me-1"></i>کپی کانفیگ
                        </button>
                        <button class="btn btn-sm btn-outline-success open-qr" data-config="{{ purchase.vpn_config }}">
                            <i class="fas fa-qrcode me-1"></i>نمایش QR کد
                        </button>
                    </div>
                    <div class="vpn-config-box">
                        <pre><code>{{ purchase.vpn_config }}</code></pre>
                    </div>
                </div>
            </div>
            {% elif purchase.status == 'pending' %}
            <div class="col-md-6">
                <div class="alert alert-info mt-3 mt-md-0">
                    <i class="fas fa-info-circle me-2"></i>سفارش شما در حال بررسی است و به زودی تأیید خواهد شد.
                </div>
            </div>
            {% elif purchase.status == 'rejected' %}
            <div class="col-md-6">
                <div class="alert alert-danger mt-3 mt-md-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>متأسفانه سفارش شما تأیید نشد. لطفاً با پشتیبانی تماس بگیرید.
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% empty %}
<div class="empty-state text-center p-5">
    <div class="empty-state-icon mb-4">
        <i class="fas fa-shopping-cart fa-3x text-muted"></i>
    </div>
    <h4>هنوز خریدی انجام نداده‌اید!</h4>
    <p class="text-muted mb-4">برای استفاده از سرویس VPN، ابتدا یک پلن خریداری کنید.</p>
    <a href="{% url 'shop:plan_list' %}" class="btn btn-primary">
        <i class="fas fa-tags me-2"></i>مشاهده پلن‌ها
    </a>
</div>
{% endfor %}

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">QR کد کانفیگ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrcode-container"></div>
                <p class="mt-3 mb-0">برای اسکن، دوربین گوشی خود را روی QR کد بگیرید.</p>
            </div>
        </div>
    </div>
</div>

<style>
    .purchase-card {
        transition: transform 0.2s;
        border-radius: 12px;
        overflow: hidden;
    }

    .purchase-card:hover {
        transform: translateY(-5px);
    }

    .card-header {
        padding: 15px 20px;
    }

    .info-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }

    .info-item i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }

    .config-actions {
        display: flex;
        gap: 10px;
    }

    .empty-state {
        background-color: #f8f9fa;
        border-radius: 15px;
        padding: 40px;
    }

    .empty-state-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }

    #qrcode-container {
        display: inline-block;
        padding: 10px;
        background-color: white;
        border-radius: 5px;
        margin: 0 auto;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy configuration to clipboard
        const copyBtns = document.querySelectorAll('.copy-config');
        copyBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const configText = this.getAttribute('data-config');
                navigator.clipboard.writeText(configText).then(() => {
                    // Change button text temporarily
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-check me-1"></i>کپی شد';
                    setTimeout(() => {
                        this.innerHTML = originalText;
                    }, 2000);
                });
            });
        });

        // Generate QR code
        const qrBtns = document.querySelectorAll('.open-qr');
        const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));

        qrBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const configText = this.getAttribute('data-config');
                const qrContainer = document.getElementById('qrcode-container');
                qrContainer.innerHTML = '';

                // Generate QR code
                const qr = qrcode(0, 'L');
                qr.addData(configText);
                qr.make();
                qrContainer.innerHTML = qr.createImgTag(5);

                // Show modal
                qrModal.show();
            });
        });
    });
</script>
{% endblock %}