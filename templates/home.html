{% extends "base.html" %}
{% block title %}ورود به سیستم | VPN Store{% endblock %}

{% block content %}
{% csrf_token %}

<div class="container-fluid min-vh-100 d-flex flex-column justify-content-center align-items-center px-3 auth-page">

    <div class="text-center mb-5 logo-section">
        <div class="logo-wrapper mb-4">
            <i class="fas fa-shield-alt logo-icon"></i>
            <div class="logo-pulse"></div>
        </div>
        <h1 class="h2 mb-3 brand-title">
            <span class="gradient-text">VPN</span>
            <span style="color: var(--tg-theme-text-color);">Store</span>
        </h1>
        <p class="lead subtitle" style="color: var(--tg-theme-hint-color);">
            <i class="fas fa-lock me-2 text-success"></i>امن
            <span class="mx-2">•</span>
            <i class="fas fa-rocket me-2 text-primary"></i>سریع
            <span class="mx-2">•</span>
            <i class="fas fa-user-shield me-2 text-info"></i>خصوصی
        </p>
    </div>

    {% if user.is_authenticated %}
    <div class="card auth-card shadow-lg w-100 fade-in">
        <div class="card-body text-center py-5">
            <div class="success-container">
                <div class="success-checkmark mb-4">
                    <div class="check-icon">
                        <span class="icon-line line-tip"></span>
                        <span class="icon-line line-long"></span>
                        <div class="icon-circle"></div>
                        <div class="icon-fix"></div>
                    </div>
                </div>
                <h3 class="mb-3 welcome-text">خوش آمدید، {{ user.first_name|default:user.username }}!</h3>
                <p class="mb-4" style="color: var(--tg-theme-hint-color);">شما با موفقیت وارد شدید. در حال انتقال...</p>
                <div class="loading-dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card auth-card shadow-lg w-100 fade-in">
        <div class="card-body p-4 p-md-5">
            <div id="auth-container">
                <div id="loading-state" class="loading-container text-center">
                    <div class="telegram-loader mb-4">
                        <i class="fab fa-telegram-plane"></i>
                    </div>
                    <h4 class="mb-2 auth-title">در حال احراز هویت</h4>
                    <p class="mb-4" style="color: var(--tg-theme-hint-color);">لطفاً چند لحظه صبر کنید...</p>
                    <div class="progress auth-progress">
                        <div class="progress-bar" role="progressbar" style="width: 10%"></div>
                    </div>
                </div>

                <div id="error-state" class="error-container text-center" style="display: none;">
                    <div class="error-icon-wrapper mb-4">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h4 class="mb-3 error-title">خطا در احراز هویت</h4>
                    <div id="error-message" class="error-message mb-4" style="color: var(--tg-theme-hint-color);"></div>
                    <button id="retry-btn" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-redo me-2"></i> تلاش مجدد
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
    #app-container {
      padding-top: 0 !important;
      padding-bottom: 0 !important;
    }
    .tg-header, .tg-bottom-nav {
      display: none;
    }

    .auth-page {
        background: var(--tg-theme-bg-color);
        position: relative;
        overflow: hidden;
    }

    /* Logo Section */
    .logo-wrapper {
        position: relative;
        width: 100px;
        height: 100px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .logo-icon {
        font-size: 4rem;
        color: var(--tg-theme-accent);
        animation: float 3s ease-in-out infinite;
        z-index: 2;
    }
    .logo-pulse {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background-color: var(--tg-theme-accent);
        animation: pulse 2s ease-out infinite;
        z-index: 1;
    }
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    @keyframes pulse {
        0% { transform: scale(0.8); opacity: 0.5; }
        70% { transform: scale(1.5); opacity: 0; }
        100% { transform: scale(1.5); opacity: 0; }
    }

    /* Brand Title */
    .brand-title { font-weight: 800; }
    .gradient-text {
        background: linear-gradient(45deg, var(--tg-theme-accent), var(--tg-theme-link-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* Auth Card */
    .auth-card {
        max-width: 400px;
        background: var(--tg-theme-secondary-bg-color);
    }

    /* Telegram Loader Animation */
    .telegram-loader {
        font-size: 3rem;
        color: var(--tg-theme-accent);
        animation: fly 2.5s ease-in-out infinite;
    }
    @keyframes fly {
        0% { transform: translateY(0px) rotate(0deg); }
        25% { transform: translateY(-15px) rotate(-10deg); }
        50% { transform: translateY(0px) rotate(0deg); }
        75% { transform: translateY(15px) rotate(10deg); }
        100% { transform: translateY(0px) rotate(0deg); }
    }

    /* Progress Bar */
    .auth-progress {
        height: 8px;
        border-radius: 4px;
        background: rgba(var(--tg-theme-text-color-rgb), 0.1);
        overflow: hidden;
    }
    .progress-bar {
        background: var(--tg-theme-accent);
        transition: width 0.5s ease-in-out;
    }

    /* Success Animation */
    .success-checkmark { width: 80px; height: 80px; margin: 0 auto; }
    .check-icon {
        width: 80px; height: 80px; position: relative; border-radius: 50%;
        box-sizing: content-box; border: 4px solid #4caf50;
        transform: scale(0);
        animation: scale-in 0.4s ease-out forwards;
    }
    @keyframes scale-in { from {transform: scale(0);} to {transform: scale(1);}}

    .icon-line { height: 5px; background-color: #4caf50; display: block; border-radius: 2px; position: absolute; z-index: 10; }
    .line-tip { top: 46px; left: 14px; width: 0; transform: rotate(45deg); animation: draw-line 0.3s ease-out 0.4s forwards; }
    .line-long { top: 38px; right: 8px; width: 0; transform: rotate(-45deg); animation: draw-line 0.4s ease-out 0.6s forwards; }

    @keyframes draw-line {
        to { width: 25px; }
    }
    @keyframes draw-line-long {
        to { width: 47px; }
    }
    .line-long { animation-name: draw-line-long; }

    /* Error Animation */
    .error-icon-wrapper {
        width: 80px; height: 80px; margin: 0 auto; border-radius: 50%;
        background: #f44336; color: white; display: flex; align-items: center; justify-content: center;
        font-size: 2.5rem; animation: shake 0.5s, scale-in 0.4s;
    }
    @keyframes shake {
        10%, 90% { transform: translate3d(-1px, 0, 0); }
        20%, 80% { transform: translate3d(2px, 0, 0); }
        30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        40%, 60% { transform: translate3d(4px, 0, 0); }
    }

    /* Loading Dots */
    .loading-dots { display: flex; justify-content: center; gap: 8px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--tg-theme-accent); animation: dot-pulse 1.4s infinite ease-in-out both; }
    .dot:nth-child(2) { animation-delay: -0.16s; }
    .dot:nth-child(3) { animation-delay: -0.32s; }
    @keyframes dot-pulse {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1.0); }
    }
</style>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if user.is_authenticated %}
        setTimeout(() => { window.location.href = "{% url 'shop:plan_list' %}"; }, 2500);
        return;
    {% endif %}

    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const errorMessageEl = document.getElementById('error-message');
    const retryBtn = document.getElementById('retry-btn');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (!window.Telegram || !window.Telegram.WebApp) {
        showError('لطفاً از طریق اپلیکیشن تلگرام وارد شوید.');
        return;
    }

    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    if (!tg.initData) {
        showError('اطلاعات کاربری تلگرام یافت نشد. لطفاً از طریق ربات وارد شوید.');
        return;
    }

    retryBtn.addEventListener('click', () => {
        errorState.style.display = 'none';
        loadingState.style.display = 'block';
        authenticate(tg.initData);
    });

    function updateProgress(percent) {
        const progressBar = loadingState.querySelector('.progress-bar');
        if (progressBar) progressBar.style.width = percent + '%';
    }

    function authenticate(initData) {
        updateProgress(25);
        setTimeout(() => {
            fetch("{% url 'shop:telegram_seamless_auth' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({'init_data': initData})
            })
            .then(response => {
                updateProgress(75);
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    updateProgress(100);
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    throw new Error(data.error || 'Authentication failed on server.');
                }
            })
            .catch(error => {
                console.error('Auth error:', error);
                showError('خطا در ارتباط با سرور: ' + error.message);
            });
        }, 1000);
    }

    function showError(message) {
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        errorMessageEl.textContent = message;
    }

    setTimeout(() => { authenticate(tg.initData); }, 500);
});
</script>
{% endblock %}