{% extends 'base.html' %}
{% load static %}
{% block title %}Login to Store{% endblock %}
{% block content %}
<div class="row justify-content-center"><div class="col-md-6"><div class="card shadow"><div class="card-body text-center py-5">
    <h2 class="mb-4">Welcome to the VPN Store</h2>
    <div id="status-message"><p class="text-muted mb-4">Authenticating you via Telegram...</p><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>
</div></div></div></div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if ({{ user.is_authenticated|yesno:"true,false" }}) { window.location.href = "{% url 'core:plan_list' %}"; return; }
    const tg = window.Telegram.WebApp;
    tg.ready();
    if (tg.initData) {
        fetch("{% url 'core:telegram_seamless_auth' %}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ 'init_data': tg.initData })
        }).then(response => response.json()).then(data => {
            if (data.success) { window.location.href = "{% url 'core:plan_list' %}"; } 
            else { document.getElementById('status-message').innerHTML = `<p class="text-danger">Error: ${data.error || 'Invalid'}</p>`; }
        }).catch(error => { document.getElementById('status-message').innerHTML = '<p class="text-danger">Server Error</p>'; });
    } else { document.getElementById('status-message').innerHTML = '<p class="text-danger fw-bold">Please open this page inside Telegram.</p>'; }
});
</script>
{% endblock %}