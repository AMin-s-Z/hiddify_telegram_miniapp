{% extends "base.html" %}
{% block title %}جزئیات خرید | VPN Store{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-2">
    <div class="card purchase-details-card fade-in">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h3 class="h4 mb-1">جزئیات خرید</h3>
                    <p class="mb-0 small" style="color: var(--tg-theme-hint-color);">شماره سفارش: #{{ purchase.id }}</p>
                </div>
                <div>
                    {% if purchase.status == 'approved' %}<span class="badge status-badge bg-success"><i class="fas fa-check-circle me-1"></i>تأیید شده</span>
                    {% elif purchase.status == 'pending' %}<span class="badge status-badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>در انتظار</span>
                    {% elif purchase.status == 'rejected' %}<span class="badge status-badge bg-danger"><i class="fas fa-times-circle me-1"></i>رد شده</span>
                    {% endif %}
                </div>
            </div>

            <ul class="info-list">
                <li><span>پلن</span><strong>{{ purchase.plan.name }}</strong></li>
                <li><span>مبلغ</span><strong>{{ purchase.plan.price|floatformat:"0" }} تومان</strong></li>
                <li><span>تاریخ خرید</span><strong>{{ purchase.purchase_date|date:"Y/m/d H:i" }}</strong></li>
                <li><span>تاریخ انقضا</span><strong>{{ purchase.expiry_date|date:"Y/m/d" }}</strong></li>
            </ul>

            {% if purchase.status == 'approved' and purchase.vpn_config %}
            <div class="config-section mt-4">
                <h5 class="mb-3"><i class="fas fa-shield-alt text-success me-2"></i>کانفیگ VPN</h5>
                <div class="vpn-config-box">
                    <pre id="vpn-config-text">{{ purchase.vpn_config }}</pre>
                </div>
                <div class="config-actions mt-3">
                    <button class="btn btn-sm btn-primary" onclick="copyConfig()"><i class="fas fa-copy me-1"></i> کپی</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="showQRCode()"><i class="fas fa-qrcode me-1"></i> نمایش QR</button>
                </div>
            </div>
            {% elif purchase.status == 'pending' %}
            <div class="alert alert-info mt-4 text-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                سفارش شما در حال بررسی است.
            </div>
            {% elif purchase.status == 'rejected' %}
            <div class="alert alert-danger mt-4 text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                متأسفانه این سفارش رد شده است.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #fff;">
            <div class="modal-header">
                <h5 class="modal-title" style="color:#000;">کد QR کانفیگ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div id="qrcode-container"></div>
            </div>
        </div>
    </div>
</div>

<style>
    .purchase-details-card {
        background: var(--tg-theme-secondary-bg-color);
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 6px 12px;
        border-radius: 20px;
    }
    .info-list {
        list-style: none;
        padding: 0;
        margin: 0;
        border-top: 1px solid rgba(var(--tg-theme-text-color-rgb), 0.1);
    }
    .info-list li {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid rgba(var(--tg-theme-text-color-rgb), 0.1);
        font-size: 0.9rem;
    }
    .info-list li span {
        color: var(--tg-theme-hint-color);
    }
    .vpn-config-box {
        background: var(--tg-theme-bg-color);
        border-radius: var(--tg-border-radius-md);
        padding: 15px;
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid rgba(var(--tg-theme-text-color-rgb), 0.1);
    }
    .vpn-config-box pre {
        white-space: pre-wrap;
        word-break: break-all;
        margin: 0;
        font-size: 0.85rem;
        color: var(--tg-theme-text-color);
    }
    .config-actions .btn {
        border-radius: var(--tg-border-radius-sm);
    }
    .modal-content {
        border-radius: var(--tg-border-radius-lg);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
    function copyConfig() {
        const configText = document.getElementById('vpn-config-text').innerText;
        navigator.clipboard.writeText(configText).then(() => {
            alert('کانفیگ با موفقیت کپی شد!');
        }).catch(err => {
            alert('خطا در کپی کردن!');
        });
    }

    function showQRCode() {
        const configText = document.getElementById('vpn-config-text').innerText;
        const qrContainer = document.getElementById('qrcode-container');
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
            text: configText,
            width: 200,
            height: 200,
        });
        const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
        qrModal.show();
    }
</script>
{% endblock %}